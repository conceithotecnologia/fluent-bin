/**
   Pré-tratamento de lançamento de saldo por endereço

	@author    Ricardo Gonçalves
	@date      15/02/2018
	@trigger   E14 B IU

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso   
   
   12/04/2018  Ricardo Gonçalves
      [-] Remoção dos campos de custos e valores
*/
CREATE OR REPLACE FUNCTION mc_01111####???()
  RETURNS trigger AS
$$
BEGIN   
   -- Tratamento de eventos de conciliação
   if new.e14_evento = -1 then
      -- Buscando registro anterior a conciliação
      select e14_saldo_u1,      e14_saldo_u2,     e14_saldor_u1,     e14_saldor_u2,     e14_saldod_u1,
             e14_saldod_u2     
        into new.e14_saldo_u1,  new.e14_saldo_u2, new.e14_saldor_u1, new.e14_saldor_u2, new.e14_saldod_u1,
             new.e14_saldod_u2
        from [(e14)] 
       where sfj_pessoa = new.sfj_pessoa
         and b1_codpro = new.b1_codpro
         and b3_endereco = new.b3_endereco
         and e14_data < new.e14_data
       order by e14_data desc, e14_evento desc
       limit 1;
      
      new.e14_saldo_u1 := coalesce(new.e14_saldo_u1, 0);
      new.e14_saldo_u2 := coalesce(new.e14_saldo_u2, 0);
      new.e14_saldor_u1 := coalesce(new.e14_saldor_u1, 0);
      new.e14_saldor_u2 := coalesce(new.e14_saldor_u2, 0);
      new.e14_saldod_u1 := coalesce(new.e14_saldod_u1, 0);
      new.e14_saldod_u2 := coalesce(new.e14_saldod_u2, 0);      
      
      new.e14_qtde_u1 := 0;
      new.e14_qtds_u1 := 0;
      new.e14_qtde_u2 := 0;  
      new.e14_qtds_u2 := 0;  
      new.e14_estado := 2;
   end if;
   
   return new;
END;
$$
  LANGUAGE 'plpgsql' VOLATILE;