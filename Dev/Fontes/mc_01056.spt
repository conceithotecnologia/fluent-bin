/*============================================================================
  Empresa..: MultCont Informática
  Descrição: Procedure para validar Tabela tg7 Before
  Autor....: Fabio Carvalho
  Data.....: 16/04/2010
  ---------------|------------------------------------------------------------
  out_res        | 0 - Falha / 1 - Sucesso
  ============================================================================*/
Create or Replace Function mc_01056####???()
Returns trigger
As $$
Declare
   nStatus    [(tg8)].tg8_status%type;
   dMaxima    [(tg8)].tg8_data%type;

begin
   if    tg_op = 'DELETE' then
      -- Faz Validações de Fechamento de Caixa
      perform mc_00784####???(old.lo8_id, old.cod_colab, old.tg7_data);

--      -- verifica se caixa foi encerrado e nao permite exclusao
--      if (select tg8_status
--            From [(tg8)]
--           Where tg8_data = old.tg8_data) = 1 then
--         raise '[[O Caixa do dia % já foi ENCERRADO e não é possivel excluir este movimento.]]',mask_00004(old.tg8_data);
--      end if;
      return old;
   else
      -- Faz Validações de Fechamento de Caixa
      perform mc_00784####???(new.lo8_id, new.cod_colab, new.tg7_data);
--      -- verifica se caixa foi encerrado e nao permite inclusao/alteracao
--      select tg8_status
--        into nStatus
--        From [(tg8)]
--       Where tg8_data = new.tg8_data;
--
--      if nStatus = 1 then
--         raise '[[O Caixa do dia % já foi ENCERRADO e não é possivel alterar/incluir este movimento.]]',mask_00004(new.tg8_data);
--      elsif not found and tg_op = 'INSERT' then
--         -- verifica se movimento é superior ao ultimo caixa
--         select max(tg8_data)
--           into dMaxima
--           from [(tg8)]
--          Where tg8_status = 1;
--
--         if new.tg8_data <= dMaxima then
--            raise '[[Não é possivel incluir caixa com data inferior a %. Verifique !]]', mask_00004(dMaxima);
--         end if;
--
--         -- insere o movimento de caixa (necessito incuir aqui devido a fk)
--         insert into [(tg8)] (tg8_data) values (new.tg8_data);
--      end if;
--
      -- verifica se conta corrente = conta corrente do caixa
      if new.ak_cc = (select ak_cc
                        from [(tg8)]
                       where tg8_data = new.tg7_data) then
         raise '[[Conta de Destino não pode ser identica à conta do caixa. Verifique !]]';
      end if;

      return new;
   end if;
end;
$$ language 'plpgsql'

